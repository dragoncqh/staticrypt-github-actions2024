<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="zh-cn"><head><meta charset="UTF-8"><meta name="copyright" content="(C) 版权 2024"><meta name="generator" content="DITA-OT"><meta name="description" content=""><title>SNMP报文格式分析</title><link rel="stylesheet" type="text/css" href="../../commonltr.css"></head><body id="SNMP报文格式分析-700D914C"><main role="main"><article role="article" aria-labelledby="ariaid-title1">
<h1 class="title topictitle1" id="ariaid-title1">SNMP报文格式分析</h1>


<div class="body conbody"><p class="shortdesc"></p>
<p class="p"></p>
<section class="section"><h2 class="title sectiontitle">实战演练之报文格式分析</h2><p class="p">Trap报文格式和上述图5所展示的结构有些差别，这里我们只分析SNMPv1和SNMPv2的Trap报文格式。trap报文前面的部分都一样，区别在PDU协议数据单元部分。</p></section>
<section class="section"><h2 class="title sectiontitle">SNMPv1 Trap报文</h2><p class="p">&nbsp; &nbsp;SNMPv1的Trap报文格式如下所示：</p><p class="p"><img class="image" src="../../images/2018-03/snmp14.png"></p><p class="p">注意：除了PDU类型和PDU长度字段外，后面的每个字段都是BER编码方式。</p><p class="p">&nbsp; trap类型”可以取以下值，其中0~6是已定义的特定trap，7及其以后的类型由供应商自定义</p><p class="p"> </p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;表2
trap类型、名称及描述信息 </p><table class="table"><caption></caption><colgroup><col><col><col></colgroup><tbody class="tbody">
<tr class="row">
<td class="entry" rowspan="1" colspan="1"><p class="p">trap类型</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">名称</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">描述信息</p></td>
</tr>
<tr class="row">
<td class="entry" rowspan="1" colspan="1"><p class="p">0</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">coldStart</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">代理进程对自己初始化</p></td>
</tr>
<tr class="row">
<td class="entry" rowspan="1" colspan="1"><p class="p">1</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">warmStart</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">代理进程对自己重新初始化</p></td>
</tr>
<tr class="row">
<td class="entry" rowspan="1" colspan="1"><p class="p">2</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">linkDown</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">一个接口已从工作状态变为故障状态(报文中的第一个变量标识此接口)</p></td>
</tr>
<tr class="row">
<td class="entry" rowspan="1" colspan="1"><p class="p">3</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">linkUp</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">一个接口已从故障状态变为工作状态(报文中的第一个变量标识此接口)</p></td>
</tr>
<tr class="row">
<td class="entry" rowspan="1" colspan="1"><p class="p">4</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">authenticationFailure</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">从SNMP管理进程收到无效共同体的报文</p></td>
</tr>
<tr class="row">
<td class="entry" rowspan="1" colspan="1"><p class="p">5</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">egpNeighborLoss</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">一个EGP邻站已变为故障状态(报文中的第一个变量包含邻站IP地址)</p></td>
</tr>
<tr class="row">
<td class="entry" rowspan="1" colspan="1"><p class="p">6</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">enterpriseSpecific</p></td>
<td class="entry" rowspan="1" colspan="1"><p class="p">在这个特定的代码段中查找trap信息 </p></td>
</tr>
</tbody></table><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;通过wireshark抓包工具，捕获一条如下的SNMP报文，接下来对其进行仔细分析。</p><p class="p">SNMPv1原始报文内容：</p><p class="p">00 23 5a 9e 58 b9&nbsp;00 4c41 49 50 55&nbsp;08
0045 00 00 48 00 00 40 00 40 11 a54e c0 a8 0a 01 c0 a8&nbsp; 0a 05&nbsp;0c&nbsp;00
00 a2 00 34 ff e0&nbsp;30 2a&nbsp;02 01 00&nbsp;04 06 70 75 62 6c
69 63&nbsp;a4 1d&nbsp;06 0a 2b 06 01 04 01 bf 08 03 02 0a&nbsp;40
04 c0 a8 0a 01&nbsp;02 01 00&nbsp;02 01 00&nbsp;4301 0e&nbsp;30 00</p><p class="p">&nbsp;</p><p class="p">目的MAC：00 23 5a 9e 58 b9</p><p class="p">源MAC：00 4c 41 49 50
55</p><p class="p">协议类型：08 00，为IP数据报</p><p class="p">IP头：45 00 00 48 00 00 40 00 40 11
a5 4e c0a8 0a 01 c0 a8 0a 05 0c</p><p class="p">UDP头：0c&nbsp;00 00 a2 00 34
ff e0</p><p class="p">其余部分都为SNMP报文，接下来我们对照前面的报文结构体来逐个分析一下。</p><p class="p">30&nbsp;表示SNMP消息是ASN.1的SEQUENCE类型；</p><p class="p">2a&nbsp;表示该SNMP报文的总长度是42(0x2a)个字节，该字段所表示的报文长度起始于它后面的第一个字节直到报文结束；</p><p class="p">02 01 00&nbsp;表示版本号，可见其确实为BER编码方式。02表示该字段是INTEGER类型；01表示该字段占1个字节；00表示版本号，该值为“版本号-1”；</p><p class="p">04 06 70 75 62 6c 69 63表示团体名，04表示该字段为OCTET STRING类型；06表示该字段占6个字节；70
75 62 6c 69 63&nbsp;表示团体名的ANSII码的十六进制形式，这里是“public”；</p><p class="p">a4 1d&nbsp;其中a4中的“4”表示这是一个trap报文，a4又叫报文的标签标记；1d表示后面还有29(0x1d)个字节的数据；</p><p class="p">06 0a 2b 06 01 04 01 bf 08 03 02 0a企业OID标识。06表示该字段是个对象标识符，OBJECT
IDENTIFIER；0a表示该字段占10(0x0a)个字节；关于SNMP的OID的编码方式有些奇特：例如1.3.6.1.2….&nbsp;取前两个数字分别记为x和y。编码时40*x+y，这里x=1，y=3，因此结果为40*1+3=43，即表示十六进制的2b。因此，这里的企业OID编码即为1.3.6.1.4.1.8072.3.2.10；</p><p class="p">40 04 c0 a8 0a 01&nbsp;同样40表示该字段为OCTET STRING&nbsp;类型；04表示IP地址占4个字节；IP地址为192.168.10.1；</p><p class="p">02 01 00&nbsp;其中00表示trap类型为coldStart；</p><p class="p">02 01 00&nbsp;其中00表示我们指定的trap即specific-trap也为coldStart类型；</p><p class="p">43 01 0e&nbsp;43表示为TimeTicks类型；01表示该字段占1个字节；0e即十进制的14表示时间标签为0.14秒，这里时间计数器以0.01秒递增；</p><p class="p">30 00&nbsp;30表示“键-值”值对的编码类型为SEQUENCE；00表示该字段占0个字节，即没有该字段。</p></section>
<section class="section"><h2 class="title sectiontitle">SNMPv2 Trap报文</h2><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;SNMPv2的Trap报文格式如图8所示：</p><p class="p"><img class="image" src="../../images/2018-03/snmp15.png"></p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;同样的，这里除了trap类型和报文长度是标准网络字节序之外，其余协议字段也均为BER编码方式。可以看到v2版的trap报文正在向统一的报文格式发展，已经非常类似普通的SNMP请求、响应报文了。</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;SNMPv2原始报文内容：</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;00
23 5a 9e 58 b9&nbsp;00 4c41 49 50 55&nbsp;08 00&nbsp;45 0000 7b 00
00 40 00 40 11 a5 1b c0 a8 0a 01 c0 a8 0a 05&nbsp;0c&nbsp;01 00 a2
00 67 04 bb&nbsp;30&nbsp;5d&nbsp;02&nbsp;0101&nbsp;04&nbsp;06&nbsp;70
75 62 6c 69 63&nbsp;a7&nbsp;50&nbsp;02&nbsp;04&nbsp;17 73 2c fb&nbsp;02&nbsp;01&nbsp;00&nbsp;02&nbsp;01&nbsp;00&nbsp;3042&nbsp;30&nbsp;0d&nbsp;06&nbsp;08&nbsp;2b
06 01 02 01 01 03 00&nbsp;43&nbsp;01&nbsp;0e&nbsp;30&nbsp;17&nbsp;06&nbsp;0a2b
06 01 06 03 01 01 04 0100&nbsp;06&nbsp;09&nbsp;2b 06 01 06 03 01 01
05 01&nbsp;30&nbsp;18&nbsp;06&nbsp;0a&nbsp;2b 06 01 06 03 01 01 04
03 0006&nbsp;0a&nbsp;2b 06 01 04 01 bf 08 03 02 0a</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;目的MAC：00 23 5a 9e 58 b9</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;源MAC：00
4c 41 49 50 55</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;协议类型：08 00，IP报文</p><p class="p">&nbsp; &nbsp; &nbsp;IP头：45 00 00 7b 00 00 40 00 40 11 a5 1b c0a8
0a 01 c0 a8 0a 05</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;UDP头：0c&nbsp;01 00
a2 00 67 04 bb</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;余下部分全为SNMP报文内容，这里我们做一下简单的约定：</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;xx标注类型；xx标注长度；xx标注真正的数据。</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;这样一来上面这串原始数据就好分析多了J</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;5d&nbsp;整个SNMP报文的编码方式为30，即SEQUENCE类型，报文长度93(0x5d)字节；</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;02&nbsp;01&nbsp;01&nbsp;版本号01即v2版本；</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;04&nbsp;06&nbsp;70 75 62 6c 69 63&nbsp;团体名70
75 62 6c 69 63&nbsp;&nbsp;即英文的“public”；</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;a7&nbsp;50&nbsp;a7表示trap类型为7，即厂商自定义trap；50表示PDU区段占80(0x50)字节；</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;02&nbsp;04&nbsp;17 73 2c fb&nbsp;请求ID为17
73 2c fb十进制的393424123；</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;02&nbsp;01&nbsp;00&nbsp;错误状态0；</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;02&nbsp;01&nbsp;00&nbsp;错误索引0；</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;42&nbsp;“变量名-值”对编码类型30即SEQUENCE类型；“变量名-值”所占总字节0x42，即66字节；&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;0d&nbsp;06&nbsp;08&nbsp;2b
06 01 02 01 01 03 00&nbsp;43&nbsp;01&nbsp;0e&nbsp;第一个“名-值”对区段编码方式30即SEQUENCE类型；第一个“名-值”对总长度0x0d，13字节；第一个变量名的编码类型0x06，时间标签；第一个变量名占0x08个字节；第一个变量名2b
06 01 02 01 01 0300，为1.3.6.1.2.1.1.3.0；第一个变量值为0x0e，即14；</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;17&nbsp;06&nbsp;0a&nbsp;2b
06 01 06 03 01 01 04 01 0006&nbsp;09&nbsp;2b 06 01 06 03 01 01 05
01&nbsp;第二个“名-值”对；变量名1.3.6.1.6.3.1.1.4.1.0；变量值1.3.6.1.6.3.1.1.5.1；</p><p class="p">&nbsp;&nbsp;&nbsp;&nbsp;30&nbsp;18&nbsp;06&nbsp;0a&nbsp;2b 06
01 06 03 01 01 04 03 0006&nbsp;0a&nbsp;2b 06 01 04 01 bf 08 03 02
0a第三个“名-值”对；变量名1.3.6.1.6.3.1.1.4.3.0；变量值1.3.6.1.4.1.8072.3.2.10；</p></section>
<section class="section"></section>
</div>
<nav role="navigation" class="related-links"><div class="familylinks"><div class="parentlink"><strong>父主题：</strong> <a class="link" href="%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7.html">网络监控</a></div></div></nav></article></main></body></html>